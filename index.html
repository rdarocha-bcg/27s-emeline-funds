<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Cagnotte</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  body { font-family: system-ui, sans-serif; max-width:600px; margin:20px auto; padding:0 10px; }
  h1 { margin-top:0; }
  ul { padding-left:20px; }
  .loading { color: #666; font-style: italic; }
  .error { color: #d32f2f; background: #ffebee; padding: 10px; border-radius: 4px; margin: 10px 0; }
  .success { color: #2e7d32; }
</style>
</head>
<body>
<h1>Cagnotte</h1>
<p>Total : <strong id="total">0 €</strong></p>
<p>Dernière mise à jour : <span id="lastUpdate">—</span></p>

<div id="status" class="loading">Chargement des données...</div>

<h2>Participants</h2>
<ul id="list"></ul>

<script>
const SHEET_ID = "12G_EmM7B28ZPl0zK27bXlEIDM-bo-6sCNZQw1e_BqGg";
const GID = "0"; // change if different sheet tab

function getCSVUrl() {
  // Add cache busting to ensure fresh data
  const cacheBust = Date.now();
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}&cacheBust=${cacheBust}`;
}

function parseDate(str){
  if(!str) return null;
  // Try direct parsing first
  let d = new Date(str);
  if(!isNaN(d)) return d;
  // Try DD/MM/YYYY format with optional time "DD/MM/YYYY HH:MM"
  const parts = str.trim().split(/[\/\s:]/);
  if(parts.length >= 3){
    let [jj,mm,aaaa,h=0,min=0] = parts;
    if(aaaa.length === 2) aaaa = '20'+aaaa;
    const d2 = new Date(+aaaa, +mm-1, +jj, +h, +min);
    if(!isNaN(d2)) return d2;
  }
  return null;
}

function updateStatus(message, className = '') {
  const statusEl = document.getElementById("status");
  statusEl.textContent = message;
  statusEl.className = className;
}

function fetchData(){
  updateStatus("Chargement des données...", "loading");
  
  Papa.parse(getCSVUrl(), {
    download: true,
    header: true,
    complete: (res) => {
      try {
        if (!res.data || res.data.length === 0) {
          updateStatus("Aucune donnée trouvée dans la feuille.", "error");
          return;
        }

        const rows = res.data.filter(r => r.Nom && r.Montant); // ignore empty rows
        
        if (rows.length === 0) {
          updateStatus("Aucun participant trouvé. Vérifiez que les colonnes 'Nom' et 'Montant' existent.", "error");
          return;
        }

        let total = 0;
        let lastDate = null;
        const ul = document.getElementById("list");
        ul.innerHTML = "";
        
        rows.forEach(r => {
          const amount = parseFloat(String(r.Montant).replace(",", "."));
          if(!isNaN(amount)) total += amount;
          
          // Parse date
          const d = parseDate(r.Date);
          if(d && (!lastDate || d > lastDate)) lastDate = d;

          const li = document.createElement("li");
          li.textContent = `${r.Nom} — ${isNaN(amount) ? "0.00" : amount.toFixed(2)} €`;
          ul.appendChild(li);
        });
        
        document.getElementById("total").textContent = total.toFixed(2) + " €";
        document.getElementById("lastUpdate").textContent = lastDate
          ? lastDate.toLocaleString('fr-FR', { dateStyle:'short', timeStyle:'short' })
          : "—";
        
        updateStatus(`Données mises à jour avec succès (${rows.length} participant${rows.length > 1 ? 's' : ''})`, "success");
        
        // Hide status after success
        setTimeout(() => {
          document.getElementById("status").style.display = 'none';
        }, 3000);
        
      } catch (error) {
        console.error('Error processing data:', error);
        updateStatus("Erreur lors du traitement des données. Vérifiez la console pour plus de détails.", "error");
      }
    },
    error: (err) => {
      console.error('CSV fetch error:', err);
      updateStatus(
        "Erreur lors du chargement des données. Vérifiez que la feuille Google Sheets est accessible publiquement.",
        "error"
      );
    }
  });
}

// Initial load
fetchData();

// Auto refresh every minute
setInterval(fetchData, 60000);

// Allow manual refresh on click
document.getElementById("status").addEventListener('click', () => {
  if (!document.getElementById("status").classList.contains('loading')) {
    fetchData();
  }
});
</script>
</body>
</html>